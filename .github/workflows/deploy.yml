name: Deploy StayNext to EC2

on:
  push:
    branches: [ main, master ]

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Print context (debug)
        run: |
          echo "GITHUB_REF_NAME=$GITHUB_REF_NAME"

      # If checkout still fails for you, keep the manual clone with PAT.
      # This step requires repo secret GH_PAT (Fine-grained: Contents Read, or Classic: repo).
      - name: Clone repo with PAT (bypass checkout 128)
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update -y && sudo apt-get install -y git rsync
          REPO="Deveshpardhi/StayNext_MERN"
          mkdir -p src && cd src
          # pick branch: main if exists else master
          TARGET="$(git ls-remote --heads https://${{ secrets.GH_PAT }}@github.com/$REPO.git main | grep -q refs/heads/main && echo main || echo master)"
          echo "Using branch: $TARGET"
          git clone --depth=1 --branch "$TARGET" https://${{ secrets.GH_PAT }}@github.com/$REPO.git .
          git rev-parse HEAD
          ls -la

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # ---------- BUILD RELEASE BUNDLE (no recursion) ----------
      - name: Build release bundle safely
        shell: bash
        run: |
          set -euo pipefail
          cd src
          rm -rf release
          mkdir -p release
          # Use rsync to EXCLUDE .git, .github, node_modules, .env, and release itself
          rsync -a ./ release/ \
            --exclude ".git" \
            --exclude ".github" \
            --exclude "node_modules" \
            --exclude ".env" \
            --exclude "release"
          # Create tarball from the release directory
          tar -czf release.tgz -C release .
          ls -lh release.tgz

      - name: Upload bundle to EC2 (SCP)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "src/release.tgz"
          target: "/home/ubuntu/app"

      - name: Deploy on EC2 (SSH)
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -euo pipefail
            APP_DIR=/home/ubuntu/app
            mkdir -p "$APP_DIR"
            cd "$APP_DIR"

            # Make sure upload exists, then extract
            [ -f release.tgz ] || { echo "ERROR: release.tgz not found"; ls -la; exit 2; }
            tar -xzf release.tgz && rm -f release.tgz
            [ -f package.json ] || { echo "ERROR: package.json missing after extract"; ls -la; exit 3; }

            # Install prod deps
            npm ci --omit=dev || npm i --omit=dev

            # Run behind Nginx (which proxies 80 -> 8080)
            export PORT=8080
            ENTRY="app.js"
            [ -f server.js ] && ENTRY="server.js"
            [ -f index.js ] && ENTRY="index.js"
            echo "Starting entry: $ENTRY on PORT=$PORT"

            if pm2 describe staynext >/dev/null 2>&1; then
              pm2 reload staynext --update-env
            else
              pm2 start "$ENTRY" --name staynext
            fi
            pm2 save
